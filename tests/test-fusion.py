import numpy as np
import matplotlib.pyplot as plt

import fusion_lib as flb

# This tests the fusion profiles produced by JET profiles (shot 42982)
#      taken when PFUSION peaks at t_idx=292 (16.61 s)
#      6.075 MW (6075418.0)


Ti = np.array([ 8313.189,  8198.816,  8091.17 ,  7994.321,  7914.864,  7867.481,
        7821.454,  7779.283,  7713.844,  7625.038,  7508.127,  7365.848,
        7186.943,  6960.574,  6734.024,  6498.964,  6241.515,  5986.755,
        5735.176,  5497.67 ,  5272.698,  5051.919,  4841.107,  4651.061,
        4464.896,  4282.391,  4104.022,  3934.803,  3781.287,  3632.684,
        3500.889,  3394.745,  3293.195,  3159.308,  2988.603,  2817.899,
        2647.195,  2483.69 ,  2336.518,  2201.841])

Ne = np.array([  7.86138100e+19,   7.86367500e+19,   7.84880200e+19,
         7.80470600e+19,   7.74094500e+19,   7.64706000e+19,
         7.54969300e+19,   7.44791100e+19,   7.35900300e+19,
         7.28335600e+19,   7.22909000e+19,   7.19466000e+19,
         7.16479100e+19,   7.13736200e+19,   7.10058300e+19,
         7.05410200e+19,   6.99372400e+19,   6.92023300e+19,
         6.84440600e+19,   6.76470800e+19,   6.68504700e+19,
         6.60535700e+19,   6.52679400e+19,   6.45119700e+19,
         6.37637800e+19,   6.29698400e+19,   6.21313100e+19,
         6.12480900e+19,   6.02377800e+19,   5.91881100e+19,
         5.80323700e+19,   5.65910300e+19,   5.52011900e+19,
         5.35616400e+19,   5.18171500e+19,   5.00747000e+19,
         4.84021000e+19,   4.63733500e+19,   4.44607900e+19,
         4.27106200e+19])

# Deuterium
Nm1 = np.array([  3.18689100e+19,   3.19812500e+19,   3.20168000e+19,
         3.18938700e+19,   3.18162100e+19,   3.15786700e+19,
         3.13071500e+19,   3.10104200e+19,   3.07902900e+19,
         3.06022900e+19,   3.04252800e+19,   3.02206800e+19,
         3.00238400e+19,   2.98484800e+19,   2.96563700e+19,
         2.93891500e+19,   2.90105200e+19,   2.86407200e+19,
         2.82421500e+19,   2.78544800e+19,   2.75264500e+19,
         2.71993300e+19,   2.68870400e+19,   2.65961400e+19,
         2.62951900e+19,   2.59585400e+19,   2.55653400e+19,
         2.51203900e+19,   2.45696600e+19,   2.39511600e+19,
         2.32364900e+19,   2.24064600e+19,   2.16081500e+19,
         2.06955300e+19,   1.97823400e+19,   1.88901000e+19,
         1.80323700e+19,   1.69819900e+19,   1.59591400e+19,
         1.49725500e+19])

# Tritium
Nm2 = np.array([  2.43585400e+19,   2.44202500e+19,   2.44334700e+19,
         2.43420000e+19,   2.42890500e+19,   2.41150100e+19,
         2.39232100e+19,   2.37217400e+19,   2.35799200e+19,
         2.34595100e+19,   2.33484600e+19,   2.32251500e+19,
         2.31213800e+19,   2.30438300e+19,   2.29535900e+19,
         2.28045100e+19,   2.25744900e+19,   2.23567400e+19,
         2.21199000e+19,   2.18992200e+19,   2.17362700e+19,
         2.15804700e+19,   2.14410100e+19,   2.13273900e+19,
         2.12159700e+19,   2.10846500e+19,   2.09130000e+19,
         2.07031200e+19,   2.04162400e+19,   2.00884600e+19,
         1.96916800e+19,   1.92006000e+19,   1.87418000e+19,
         1.81938300e+19,   1.76537100e+19,   1.71389800e+19,
         1.66566900e+19,   1.59918900e+19,   1.53426800e+19,
         1.47454400e+19])

# Surface Area
Area = np.array([   3.690838,    7.380161,   11.06828 ,   14.75417 ,   18.4388  ,
         22.12032 ,   25.79927 ,   29.47423 ,   33.14775 ,   36.81909 ,
         40.48758 ,   44.1503  ,   47.80921 ,   51.46573 ,   55.121   ,
         58.77137 ,   62.41607 ,   66.05138 ,   69.67905 ,   73.29583 ,
         76.90294 ,   80.49858 ,   84.08411 ,   87.65808 ,   91.22311 ,
         94.77758 ,   98.32429 ,  101.862   ,  105.3933  ,  108.9184  ,
        112.4412  ,  115.9635  ,  119.4911  ,  123.029   ,  126.5876  ,
        130.1814  ,  133.8356  ,  137.5802  ,  141.4491  ,  145.4804  ])

# TRANSP 2D: RMAJOR
R_major = np.array([ 2.989869,  2.989578,  2.989158,  2.98862 ,  2.987965,  2.987236,
        2.98645 ,  2.985601,  2.984679,  2.983697,  2.982643,  2.981506,
        2.980273,  2.978924,  2.977474,  2.97589 ,  2.974169,  2.972313,
        2.970323,  2.968205,  2.965956,  2.963604,  2.961101,  2.958477,
        2.955752,  2.952915,  2.949969,  2.946942,  2.94381 ,  2.940602,
        2.937309,  2.933924,  2.930488,  2.926969,  2.923381,  2.919757,
        2.916116,  2.912483,  2.908874,  2.904989])

# TRANSP 2D: RMINOR
a_minor = np.array([ 0.02665176,  0.05330632,  0.07993629,  0.1065383 ,  0.1331057 ,
        0.1596857 ,  0.1862784 ,  0.2128672 ,  0.2395078 ,  0.2661823 ,
        0.2927655 ,  0.3191756 ,  0.3453529 ,  0.3715778 ,  0.3977324 ,
        0.4237332 ,  0.4494722 ,  0.4749279 ,  0.5001292 ,  0.525052  ,
        0.5497054 ,  0.5740551 ,  0.5981105 ,  0.6218529 ,  0.6452584 ,
        0.6683083 ,  0.6909816 ,  0.7132185 ,  0.7350282 ,  0.7563455 ,
        0.7771662 ,  0.7974693 ,  0.8172022 ,  0.836369  ,  0.8549337 ,
        0.8727913 ,  0.8899211 ,  0.906247  ,  0.9217266 ,  0.9362195 ])


N_radial = len(Area)
radial_grid = np.linspace(0,1, N_radial )
dr = a_minor[-1] / N_radial
V_profile_m3  = Area * dr 
P_fusion_Wm3 = flb.alpha_heating_D_T(Nm1, Nm2, Ti)
P_fusion_Wm  = P_fusion_Wm3 * Area

P_fusion_total = flb.simps( P_fusion_Wm, a_minor, dx=dr )
print(' Total alpha power (integral Simpson): {:.2e} MW'.format( P_fusion_total/1e6 ) )
print(' Total fusion power (integral Simpson): {:.2e} MW'.format( 5*P_fusion_total/1e6 ) )

fig,axs = plt.subplots(2,3, figsize=(10,6))

axs[0,0].plot( radial_grid, Nm1 , 'C2.-',label='D' )
axs[0,0].plot( radial_grid, Nm2 , 'C1.-',label='T' )
axs[0,0].legend()
axs[1,0].plot( radial_grid, Ti/1e3, '.-' )
axs[0,1].plot( radial_grid, P_fusion_Wm3/1e6 , '.-' )
axs[1,1].plot( radial_grid, Area , '.-' )
axs[0,2].plot( a_minor, P_fusion_Wm/1e6 , 'C4.-' )
axs[1,2].plot( radial_grid, a_minor , '.-' )

axs[0,0].set_title(r'Density [m$^{-3}$]')
axs[1,0].set_title('Ion Temperature [keV]')
axs[0,1].set_title(r'Alpha power density [MW/m$^3$]')
axs[1,1].set_title(r'Surface Area [m$^2$]')
axs[0,2].set_title('Alpha power distribution [MW/m]')
axs[1,2].set_title('Minor Radius [m]')

plt.tight_layout()
plt.show()

